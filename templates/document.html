{% extends "base.html" %}

{% block title %}{{ doc_info.file_name }} - Epstein Documents OCR{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('browse') }}">Browse</a></li>
                <li class="breadcrumb-item active">{{ doc_info.file_name }}</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-file-alt me-2"></i>
            {{ doc_info.file_name }}
        </h1>
    </div>
</div>

<!-- Document Info -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Document Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tr>
                                <td><strong>File Name:</strong></td>
                                <td>{{ doc_info.file_name }}</td>
                            </tr>
                            <tr>
                                <td><strong>File Path:</strong></td>
                                <td><code>{{ doc_info.file_path }}</code></td>
                            </tr>
                            <tr>
                                <td><strong>File Type:</strong></td>
                                <td>
                                    <span class="badge bg-secondary">{{ doc_info.file_type }}</span>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>File Size:</strong></td>
                                <td>{{ "%.1f"|format(doc_info.file_size / 1024) }} KB</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Created:</strong></td>
                                <td>{{ doc_info.created[:19] }}</td>
                            </tr>
                            <tr>
                                <td><strong>Modified:</strong></td>
                                <td>{{ doc_info.modified[:19] }}</td>
                            </tr>
                            <tr>
                                <td><strong>OCR Status:</strong></td>
                                <td>
                                    {% if extracted_text %}
                                        <span class="badge bg-success">Completed</span>
                                    {% else %}
                                        <span class="badge bg-warning">Pending</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Text Length:</strong></td>
                                <td>
                                    {% if extracted_text %}
                                        {{ extracted_text|length }} characters
                                    {% else %}
                                        <span class="text-muted">Not available</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="btn-group" role="group">
                    {% if extracted_text %}
                        <a href="{{ url_for('download_text', file_path=file_path) }}" 
                           class="btn btn-primary">
                            <i class="fas fa-download me-2"></i>Download Text
                        </a>
                    {% endif %}
                    
                    <button type="button" class="btn btn-secondary" onclick="copyToClipboard()">
                        <i class="fas fa-copy me-2"></i>Copy Text
                    </button>
                    
                    <button type="button" class="btn btn-info" onclick="printText()">
                        <i class="fas fa-print me-2"></i>Print
                    </button>
                    
                    <a href="{{ url_for('search') }}?q={{ doc_info.file_name }}" 
                       class="btn btn-outline-primary">
                        <i class="fas fa-search me-2"></i>Search Similar
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Document Content -->
<div class="row">
    {% if is_image and image_url %}
    <!-- Image Display -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-image me-2"></i>
                    Document Image
                </h5>
            </div>
            <div class="card-body text-center">
                <img src="{{ image_url }}" 
                     class="img-fluid border rounded" 
                     style="max-height: 800px; cursor: pointer;"
                     onclick="toggleImageSize(this)"
                     alt="Document Image">
                <div class="mt-2">
                    <small class="text-muted">Click image to toggle size</small>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Text Content -->
    <div class="{% if is_image and image_url %}col-md-6{% else %}col-12{% endif %}">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-file-text me-2"></i>
                    Extracted Text
                </h5>
                {% if extracted_text %}
                    <div class="text-muted small">
                        {{ extracted_text|length }} characters
                    </div>
                {% endif %}
            </div>
            <div class="card-body">
                {% if extracted_text %}
                    <div id="extracted-text" class="border rounded p-3 bg-light" style="max-height: 600px; overflow-y: auto;">
                        <pre class="mb-0" style="white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 0.9em; line-height: 1.4;">{{ extracted_text }}</pre>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-clock fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">OCR Processing Pending</h5>
                        <p class="text-muted">
                            This document has not been processed yet. Check back later or 
                            <a href="{{ url_for('index') }}">view the dashboard</a> for processing status.
                        </p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Text Analysis (if text is available) -->
{% if extracted_text %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>
                    Text Analysis
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 text-center">
                        <h5 class="text-primary">{{ extracted_text.split()|length }}</h5>
                        <small class="text-muted">Words</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <h5 class="text-success">{{ extracted_text.split('\n')|length }}</h5>
                        <small class="text-muted">Lines</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <h5 class="text-info">{{ extracted_text|length }}</h5>
                        <small class="text-muted">Characters</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <h5 class="text-warning">{{ "%.1f"|format(extracted_text.split()|length / extracted_text.split('\n')|length) if extracted_text.split('\n')|length > 0 else 0 }}</h5>
                        <small class="text-muted">Words/Line</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    function toggleImageSize(img) {
        if (img.style.maxHeight === '800px') {
            img.style.maxHeight = 'none';
            img.style.width = '100%';
        } else {
            img.style.maxHeight = '800px';
            img.style.width = 'auto';
        }
    }
    
    function copyToClipboard() {
        const textElement = document.getElementById('extracted-text');
        if (!textElement) {
            alert('No text available to copy');
            return;
        }
        
        const text = textElement.textContent;
        navigator.clipboard.writeText(text).then(function() {
            // Show success message
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check me-2"></i>Copied!';
            button.classList.remove('btn-secondary');
            button.classList.add('btn-success');
            
            setTimeout(function() {
                button.innerHTML = originalText;
                button.classList.remove('btn-success');
                button.classList.add('btn-secondary');
            }, 2000);
        }).catch(function(err) {
            console.error('Could not copy text: ', err);
            alert('Failed to copy text to clipboard');
        });
    }
    
    function printText() {
        const textElement = document.getElementById('extracted-text');
        if (!textElement) {
            alert('No text available to print');
            return;
        }
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
                <head>
                    <title>{{ doc_info.file_name }} - Extracted Text</title>
                    <style>
                        body { font-family: 'Courier New', monospace; margin: 20px; }
                        h1 { color: #333; border-bottom: 2px solid #333; padding-bottom: 10px; }
                        pre { white-space: pre-wrap; line-height: 1.4; }
                    </style>
                </head>
                <body>
                    <h1>{{ doc_info.file_name }}</h1>
                    <p><strong>File Path:</strong> {{ doc_info.file_path }}</p>
                    <p><strong>Extracted:</strong> ${new Date().toLocaleString()}</p>
                    <hr>
                    <pre>${textElement.textContent}</pre>
                </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    }
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            if (e.key === 'c' && e.shiftKey) {
                e.preventDefault();
                copyToClipboard();
            } else if (e.key === 'p') {
                e.preventDefault();
                printText();
            }
        }
    });
</script>
{% endblock %}
