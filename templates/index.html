{% extends "base.html" %}

{% block title %}Home - Epstein Documents Browser{% endblock %}

{% block description %}Browse and search through {{ "{:,}".format(total_images) }} congressional document images with advanced OCR capabilities. Open source document management system by Mark Rizzn Hopkins.{% endblock %}

{% block og_title %}Epstein Documents Browser - {{ "{:,}".format(total_images) }} Congressional Records{% endblock %}

{% block og_description %}Browse and search through {{ "{:,}".format(total_images) }} congressional document images with advanced OCR capabilities. Open source document management system.{% endblock %}

{% block twitter_title %}Epstein Documents Browser - {{ "{:,}".format(total_images) }} Congressional Records{% endblock %}

{% block twitter_description %}Browse and search through {{ "{:,}".format(total_images) }} congressional document images with advanced OCR capabilities. Open source document management system.{% endblock %}

{% block content %}

<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-file-alt me-2"></i>
            Epstein Documents Browser
        </h1>
    </div>
</div>

{% if total_images > 0 %}
<!-- Quick Start -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h5 class="card-title mb-3">
                    <i class="fas fa-play me-2"></i>
                    Start Browsing Documents
                </h5>
                <p class="card-text mb-3">
                    Browse through {{ "{:,}".format(total_images) }} congressional documents with Archive.org-style navigation
                </p>
                <a href="{{ url_for('view_image', image_id=first_image.id) }}" class="btn btn-light btn-lg">
                    <i class="fas fa-book-open me-2"></i>
                    Start Reading
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Statistics -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="stats-card">
            <div class="stat-number" id="total-images">{{ "{:,}".format(total_images) }}</div>
            <div class="text-muted">Total Documents</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stats-card">
            <div class="stat-number" id="ocr-count">Loading...</div>
            <div class="text-muted">With OCR Text</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stats-card">
            <div class="stat-number" id="ocr-percentage">Loading...</div>
            <div class="text-muted">OCR Progress</div>
        </div>
    </div>
</div>

<!-- Quick Navigation -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5><i class="fas fa-compass me-2"></i>Quick Navigation</h5>
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('view_image', image_id=first_image.id) }}" class="btn btn-outline-primary w-100">
                            <i class="fas fa-angle-double-left me-2"></i>First Document
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('view_image', image_id=first_image.id + total_images//2) }}" class="btn btn-outline-primary w-100">
                            <i class="fas fa-equals me-2"></i>Middle
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('view_image', image_id=first_image.id + total_images - 1) }}" class="btn btn-outline-primary w-100">
                            <i class="fas fa-angle-double-right me-2"></i>Last Document
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-secondary w-100" onclick="randomDocument()">
                            <i class="fas fa-random me-2"></i>Random
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- About Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-info-circle me-2"></i>
                    About This Project
                </h5>
                <p class="card-text">
                    This document browser provides access to <strong>33,295 pages</strong> of Epstein-related records 
                    released by the <a href="https://oversight.house.gov/release/oversight-committee-releases-epstein-records-provided-by-the-department-of-justice/" target="_blank">House Committee on Oversight and Government Reform</a> 
                    following a congressional subpoena to the Department of Justice.
                </p>
                <p class="card-text">
                    The documents were released on <strong>September 2, 2025</strong> and contain congressional records 
                    with appropriate redactions to protect victim identities and remove any child sexual abuse material.
                </p>
                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Why This Browser Exists</h6>
                    <p class="mb-0">
                        For some reason, they released this in the dumbest way possible, making the assumption that people would be too lazy to make sense of it:
                    </p>
                    <ul class="mb-0 mt-2">
                        <li>Highly redacted</li>
                        <li>Scans of individual pages</li>
                        <li>Individual pages are in individual folders</li>
                        <li>They're all .tif files</li>
                    </ul>
                    <p class="mb-0 mt-2">
                        <em>It's like they forget we're in the age of AI and can't just delegate deciphering this stuff to a machine.</em>
                    </p>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-download me-2"></i>Official Sources</h6>
                        <ul class="list-unstyled">
                            <li><a href="https://drive.google.com/drive/folders/1TrGxDGQLDLZu1vvvZDBAh-e7wN3y6Hoz" target="_blank" class="btn btn-sm btn-outline-primary me-2 mb-2">
                                <i class="fab fa-google-drive me-1"></i>Google Drive
                            </a></li>
                            <li><a href="https://www.dropbox.com/scl/fo/98fthv8otekjk28lcrnc5/AIn3egnE58MYe4Bn4fliVBw?rlkey=m7p8e9omml96fgxl13kr2nuyt&st=0xvm0p08&dl=0" target="_blank" class="btn btn-sm btn-outline-info me-2 mb-2">
                                <i class="fab fa-dropbox me-1"></i>Dropbox Backup
                            </a></li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-landmark me-2"></i>Congressional Context</h6>
                        <ul class="list-unstyled">
                            <li><a href="{{ url_for('help_context') }}" class="btn btn-sm btn-outline-warning me-2 mb-2">
                                <i class="fas fa-gavel me-1"></i>Official Context
                            </a></li>
                            <li><a href="{{ url_for('help_installation') }}" class="btn btn-sm btn-outline-success me-2 mb-2">
                                <i class="fas fa-download me-1"></i>Installation Guide
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5><i class="fas fa-search me-2"></i>Search Documents</h5>
                <div class="input-group">
                    <input type="text" class="form-control" id="search-input" placeholder="Search by filename or document content...">
                    <button class="btn btn-primary" onclick="searchDocuments()">
                        <i class="fas fa-search me-1"></i>Search
                    </button>
                </div>
                <div id="search-results" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- How to Use -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5><i class="fas fa-info-circle me-2"></i>How to Use</h5>
                <ul class="mb-0">
                    <li><strong>Navigation:</strong> Use Previous/Next buttons or arrow keys to browse documents</li>
                    <li><strong>Zoom:</strong> Click on images to zoom in/out</li>
                    <li><strong>OCR Text:</strong> Extracted text is shown alongside images when available</li>
                    <li><strong>Keyboard:</strong> Use arrow keys, Home, End for quick navigation</li>
                    <li><strong>Search:</strong> Search by filename to find specific documents</li>
                </ul>
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- No Documents -->
<div class="row">
    <div class="col-12">
        <div class="alert alert-warning text-center">
            <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
            <h4>No Documents Found</h4>
            <p>No documents have been indexed yet. Please run the indexer first.</p>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // Load OCR statistics
    fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('ocr-count').textContent = data.images_with_ocr.toLocaleString();
            document.getElementById('ocr-percentage').textContent = data.ocr_percentage.toFixed(1) + '%';
        })
        .catch(error => {
            console.error('Error loading stats:', error);
        });

    // Random document function
    function randomDocument() {
        const totalImages = {{ total_images }};
        {% if first_image %}
        const firstId = {{ first_image.id }};
        const lastId = firstId + totalImages - 1;
        const randomId = Math.floor(Math.random() * totalImages) + firstId;
        window.location.href = `/view/${randomId}`;
        {% else %}
        // No images available
        alert('No documents available at this time.');
        {% endif %}
    }

    // Search function
    function searchDocuments() {
        const query = document.getElementById('search-input').value.trim();
        if (!query) return;

        fetch(`/api/search?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                const resultsDiv = document.getElementById('search-results');
                if (data.results.length === 0) {
                    resultsDiv.innerHTML = '<div class="alert alert-info">No documents found.</div>';
                    return;
                }

                let html = '<div class="list-group">';
                data.results.forEach(result => {
                    const matchType = result.match_type || 'filename';
                    const matchBadge = matchType === 'filename' ? 
                        '<span class="badge bg-primary me-2">Filename</span>' : 
                        '<span class="badge bg-success me-2">Content</span>';
                    
                    // Add excerpt for OCR matches
                    let excerptHtml = '';
                    if (result.excerpt) {
                        // Highlight the search term in the excerpt
                        const highlightedExcerpt = result.excerpt.replace(
                            new RegExp(`(${query})`, 'gi'), 
                            '<mark>$1</mark>'
                        );
                        excerptHtml = `<div class="mt-2"><small class="text-muted">${highlightedExcerpt}</small></div>`;
                    }
                    
                    html += `
                        <a href="/view/${result.id}" class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">${result.file_name} ${matchBadge}</h6>
                                <small>${result.has_ocr_text ? '<i class="fas fa-file-text text-success"></i>' : '<i class="fas fa-clock text-muted"></i>'}</small>
                            </div>
                            <p class="mb-1 text-muted">${result.directory_path}</p>
                            ${excerptHtml}
                        </a>
                    `;
                });
                html += '</div>';
                resultsDiv.innerHTML = html;
            })
            .catch(error => {
                console.error('Search error:', error);
                document.getElementById('search-results').innerHTML = '<div class="alert alert-danger">Search failed.</div>';
            });
    }

    // Search on Enter key
    document.getElementById('search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchDocuments();
        }
    });
</script>
{% endblock %}

